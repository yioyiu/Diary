# æ¯æ—¥è®°å½•ç½‘é¡µ - é¡¹ç›®æŠ€æœ¯æ–‡æ¡£

> AIå¢å¼ºçš„æ—¥è®°/å­¦ä¹ è®°å½•å·¥å…· - æŠ€æœ¯å®ç°æŒ‡å—

## ğŸ“‘ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
- [æ ¸å¿ƒåŠŸèƒ½å®ç°](#æ ¸å¿ƒåŠŸèƒ½å®ç°)
- [API æ¥å£è®¾è®¡](#api-æ¥å£è®¾è®¡)
- [AI é›†æˆ](#ai-é›†æˆ)
- [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
- [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)

---

## é¡¹ç›®æ¦‚è¿°

### äº§å“å®šä½

è½»é‡çº§ã€AIå¢å¼ºçš„æ—¥è®°/å­¦ä¹ è®°å½•å·¥å…·ï¼Œæ ¸å¿ƒåŠŸèƒ½ï¼š

- âœ… **æ¯æ—¥è®°å½•**ï¼šæ”¯æŒ Markdown æ ¼å¼çš„æ—¥è®°/å­¦ä¹ å†…å®¹è¾“å…¥
- âœ… **AI è‡ªåŠ¨æ€»ç»“**ï¼šä¿å­˜æ—¶è‡ªåŠ¨ç”Ÿæˆç®€çŸ­æ‘˜è¦ï¼Œæ˜¾ç¤ºåœ¨æ—¥å†æ ¼å­ä¸­
- âœ… **æœˆåº¦å›é¡¾**ï¼šåŸºäºå½“æœˆæ‰€æœ‰è®°å½•ç”Ÿæˆ AI å­¦ä¹ æŠ¥å‘Š
- âœ… **äº‘ç«¯å­˜å‚¨**ï¼šä½¿ç”¨ Supabase æŒä¹…åŒ–æ‰€æœ‰æ•°æ®

### æ ¸å¿ƒä»·å€¼

1. **å®æ—¶è®°å½•**ï¼šéšæ—¶è®°å½•å½“å¤©æƒ³æ³•ã€å­¦ä¹ å†…å®¹ã€æ—¥è®°
2. **æ™ºèƒ½æ‘˜è¦**ï¼šAI è‡ªåŠ¨æ€»ç»“ï¼Œå¿«é€Ÿå›é¡¾æ¯æ—¥è¦ç‚¹
3. **æœˆåº¦å¤ç›˜**ï¼šè‡ªåŠ¨ç”Ÿæˆ"å­¦ä¹ æœˆæŠ¥"æˆ–"æˆé•¿å›é¡¾"
4. **æ•°æ®æŒä¹…åŒ–**ï¼šæ‰€æœ‰å†…å®¹å­˜å‚¨åœ¨ Supabaseï¼Œå¯éšæ—¶æŸ¥çœ‹

---

## æŠ€æœ¯æ ˆ

### å‰ç«¯æ¡†æ¶
- **Next.js 13+** (App Router) - æ¨è
- **React 18+**
- **TypeScript** - ç±»å‹å®‰å…¨

### UI æ¡†æ¶
- **Tailwind CSS** - æ ·å¼æ¡†æ¶
- **shadcn/ui** (å¯é€‰) - ç»„ä»¶åº“

### åç«¯æœåŠ¡
- **Supabase** - æ•°æ®åº“ + è®¤è¯
- **ZHIPU AI (GLM 4.5 FLASH)** - AI æ€»ç»“ç”Ÿæˆ
- **Next.js API Routes** - æœåŠ¡ç«¯æ¥å£

### å¼€å‘å·¥å…·
- **ESLint** - ä»£ç æ£€æŸ¥
- **Prettier** - ä»£ç æ ¼å¼åŒ–

---

## é¡¹ç›®ç»“æ„

```
project-root/
â”‚
â”œâ”€â”€ README.md                    # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ package.json                 # é¡¹ç›®ä¾èµ–ä¸è„šæœ¬
â”œâ”€â”€ .env.local                   # ç¯å¢ƒå˜é‡ï¼ˆSupabase + AI keysï¼‰
â”œâ”€â”€ tsconfig.json                # TypeScript é…ç½®
â”œâ”€â”€ next.config.js               # Next.js é…ç½®
â”œâ”€â”€ tailwind.config.js           # Tailwind é…ç½®
â”‚
â”œâ”€â”€ public/                      # é™æ€èµ„æº
â”‚   â”œâ”€â”€ icons/                   # å›¾æ ‡æ–‡ä»¶
â”‚   â”œâ”€â”€ images/                  # å›¾ç‰‡èµ„æº
â”‚   â””â”€â”€ favicon.ico              # ç½‘ç«™å›¾æ ‡
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                     # Next.js 13+ App Router
â”‚   â”‚   â”œâ”€â”€ layout.tsx           # å…¨å±€å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ page.tsx             # é¦–é¡µï¼ˆå¯¼èˆªåˆ° record/reviewï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ record/              # è®°å½•é¡µé¢è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx         # è®°å½•é¡µä¸»ç»„ä»¶ï¼ˆæ—¥å† + ç¼–è¾‘å™¨ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Calendar.tsx      # æ—¥å†ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Editor.tsx        # Markdown ç¼–è¾‘å™¨ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ actions.ts            # Server Actionsï¼ˆä¿å­˜ã€ç”Ÿæˆæ€»ç»“ï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ review/              # å›é¡¾é¡µé¢è·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx         # å›é¡¾é¡µä¸»ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SummaryCard.tsx   # æœˆåº¦æ€»ç»“å¡ç‰‡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Charts.tsx        # å›¾è¡¨ç»„ä»¶ï¼ˆè¯äº‘ã€é¢‘ç‡ã€æƒ…ç»ªï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ DailyList.tsx     # æ¯æ—¥æ‘˜è¦åˆ—è¡¨
â”‚   â”‚   â”‚   â””â”€â”€ actions.ts            # Server Actionsï¼ˆè·å–æœˆåº¦æ•°æ®ï¼‰
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ api/                 # API è·¯ç”±ï¼ˆå¯é€‰ï¼Œç”¨äºå¤æ‚é€»è¾‘ï¼‰
â”‚   â”‚       â”œâ”€â”€ saveRecord/route.ts
â”‚   â”‚       â”œâ”€â”€ generateDailySummary/route.ts
â”‚   â”‚       â””â”€â”€ generateMonthlyReview/route.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                     # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts        # Supabase å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ç«¯ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ server.ts        # Supabase å®¢æˆ·ç«¯ï¼ˆæœåŠ¡ç«¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â””â”€â”€ zhipu.ts         # ZHIPU AI å®¢æˆ·ç«¯å°è£…
â”‚   â”‚   â”œâ”€â”€ utils.ts             # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ date.ts              # æ—¥æœŸå¤„ç†å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â””â”€â”€ globals.css          # å…¨å±€æ ·å¼ï¼ˆTailwind å¯¼å…¥ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ types/                   # TypeScript ç±»å‹å®šä¹‰
â”‚       â”œâ”€â”€ record.ts            # DailyRecord ç±»å‹
â”‚       â”œâ”€â”€ summary.ts           # MonthlySummary ç±»å‹
â”‚       â””â”€â”€ database.ts          # Supabase æ•°æ®åº“ç±»å‹ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚
â””â”€â”€ scripts/                     # å·¥å…·è„šæœ¬
    â”œâ”€â”€ seed.ts                  # æ•°æ®åº“åˆå§‹åŒ–/ç§å­æ•°æ®
    â””â”€â”€ generate-types.ts        # ç”Ÿæˆ Supabase ç±»å‹å®šä¹‰
```

---

## æ•°æ®åº“è®¾è®¡

### Supabase è¡¨ç»“æ„

#### 1. `daily_records` - æ¯æ—¥è®°å½•è¡¨

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| `id` | `uuid` | PRIMARY KEY, DEFAULT uuid_generate_v4() | ä¸»é”® |
| `user_id` | `uuid` | NOT NULL, FOREIGN KEY â†’ auth.users(id) | ç”¨æˆ·IDï¼ˆå…³è” Supabase Authï¼‰ |
| `date` | `date` | NOT NULL, UNIQUE(user_id, date) | è®°å½•æ—¥æœŸ |
| `content` | `text` | NOT NULL | ç”¨æˆ·è¾“å…¥çš„åŸå§‹å†…å®¹ |
| `summary` | `text` | NULL | AI ç”Ÿæˆçš„ç®€çŸ­æ‘˜è¦ï¼ˆç”¨äºæ—¥å†æ˜¾ç¤ºï¼‰ |
| `created_at` | `timestamp` | DEFAULT now() | åˆ›å»ºæ—¶é—´ |
| `updated_at` | `timestamp` | DEFAULT now() | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
```sql
-- å”¯ä¸€ç´¢å¼•ï¼šç¡®ä¿ä¸€ä¸ªç”¨æˆ·ä¸€å¤©åªæœ‰ä¸€æ¡è®°å½•
CREATE UNIQUE INDEX idx_daily_records_user_date 
ON daily_records(user_id, date);

-- æŸ¥è¯¢ç´¢å¼•ï¼šæŒ‰ç”¨æˆ·å’Œæ—¥æœŸèŒƒå›´æŸ¥è¯¢
CREATE INDEX idx_daily_records_user_created 
ON daily_records(user_id, created_at DESC);
```

**Row Level Security (RLS) ç­–ç•¥ï¼š**
```sql
-- ç”¨æˆ·åªèƒ½æŸ¥çœ‹å’Œä¿®æ”¹è‡ªå·±çš„è®°å½•
ALTER TABLE daily_records ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own records"
  ON daily_records FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own records"
  ON daily_records FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own records"
  ON daily_records FOR UPDATE
  USING (auth.uid() = user_id);
```

#### 2. `monthly_summary` - æœˆåº¦æ€»ç»“è¡¨ï¼ˆå¯é€‰ï¼‰

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| `id` | `uuid` | PRIMARY KEY | ä¸»é”® |
| `user_id` | `uuid` | NOT NULL, FOREIGN KEY | ç”¨æˆ·ID |
| `month` | `text` | NOT NULL, UNIQUE(user_id, month) | æœˆä»½æ ‡è¯†ï¼Œæ ¼å¼ï¼š"YYYY-MM" |
| `summary` | `text` | NOT NULL | AI ç”Ÿæˆçš„æœˆåº¦æ€»ç»“ï¼ˆJSON æ ¼å¼ï¼‰ |
| `created_at` | `timestamp` | DEFAULT now() | åˆ›å»ºæ—¶é—´ |
| `updated_at` | `timestamp` | DEFAULT now() | æ›´æ–°æ—¶é—´ |

**è¯´æ˜ï¼š**
- å¦‚æœæ¯æ¬¡è¿›å…¥å›é¡¾é¡µéƒ½é‡æ–°ç”Ÿæˆï¼Œæ­¤è¡¨å¯çœç•¥
- å¦‚æœæƒ³ä¿å­˜å†å²æœˆæŠ¥ï¼Œå»ºè®®ä¿ç•™æ­¤è¡¨

---

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### åŠŸèƒ½ 1ï¼šæ¯æ—¥è®°å½•é¡µé¢ (`/record`)

#### é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              [å¯¼èˆªæ ]                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚  ä»Šæ—¥è®°å½•                     â”‚
â”‚   æ—¥å†è§†å›¾    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚              â”‚  â”‚                        â”‚  â”‚
â”‚  [1] [2] [3] â”‚  â”‚   Markdown ç¼–è¾‘å™¨      â”‚  â”‚
â”‚  [4] [5] [6] â”‚  â”‚   (æ”¯æŒå®æ—¶é¢„è§ˆ)        â”‚  â”‚
â”‚  ...         â”‚  â”‚                        â”‚  â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚  [ä¿å­˜] [æ¸…ç©º]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°è¦ç‚¹

1. **æ—¥å†ç»„ä»¶ (`Calendar.tsx`)**
   - æ˜¾ç¤ºå½“æœˆæ‰€æœ‰æ—¥æœŸ
   - æœ‰è®°å½•çš„æ—¥æœŸé«˜äº®æ˜¾ç¤º
   - ç‚¹å‡»æ—¥æœŸæ˜¾ç¤ºè¯¦æƒ…ï¼ˆModal/Drawerï¼‰
   - æ˜¾ç¤º `summary` å­—æ®µå†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

2. **ç¼–è¾‘å™¨ç»„ä»¶ (`Editor.tsx`)**
   - æ”¯æŒ Markdown è¯­æ³•
   - å®æ—¶é¢„è§ˆï¼ˆå¯é€‰ï¼‰
   - è‡ªåŠ¨ä¿å­˜è‰ç¨¿åˆ° `localStorage`
   - é˜²æŠ–ä¿å­˜ï¼ˆé¿å…é¢‘ç¹å†™å…¥ï¼‰

3. **ä¿å­˜æµç¨‹**

```typescript
// src/app/record/actions.ts
'use server'

export async function saveDailyRecord(date: string, content: string) {
  // 1. ä¿å­˜åŸå§‹å†…å®¹åˆ° Supabase
  const { data: record, error } = await supabase
    .from('daily_records')
    .upsert({
      user_id: userId,
      date,
      content,
      updated_at: new Date().toISOString()
    })
    .select()
    .single();

  if (error) throw error;

  // 2. è°ƒç”¨ AI ç”Ÿæˆæ‘˜è¦
  const summary = await generateDailySummary(content);

  // 3. æ›´æ–°è®°å½•çš„ summary å­—æ®µ
  await supabase
    .from('daily_records')
    .update({ summary })
    .eq('id', record.id);

  return { success: true, summary };
}
```

### åŠŸèƒ½ 2ï¼šæœˆåº¦å›é¡¾é¡µé¢ (`/review`)

#### é¡µé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [å¯¼èˆªæ ] - 2025å¹´3æœˆå›é¡¾                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š æœ¬æœˆå­¦ä¹ æ€»ç»“ï¼ˆAIç”Ÿæˆï¼‰                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ æ•´ä½“æ¦‚è¿°ï¼š...                      â”‚   â”‚
â”‚  â”‚  â€¢ 5ä¸ªé‡è¦æ”¶è·ï¼š...                   â”‚   â”‚
â”‚  â”‚  â€¢ å¸¸è§ä¸»é¢˜ï¼šç»Ÿè®¡ã€äº¤æ˜“ã€è‹±è¯­...      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ·ï¸  ä¸»é¢˜è¯äº‘å›¾                              â”‚
â”‚  [å¯è§†åŒ–å›¾è¡¨]                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“… æœ¬æœˆæ¯æ—¥æ‘˜è¦åˆ—è¡¨                          â”‚
â”‚  â€¢ 3æœˆ1æ—¥ï¼šå­¦ä¹ React Hooks...               â”‚
â”‚  â€¢ 3æœˆ2æ—¥ï¼šå®Œæˆäº¤æ˜“ç³»ç»Ÿè®¾è®¡...               â”‚
â”‚  ...                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®ç°è¦ç‚¹

1. **æ•°æ®è·å–**
   - è·å–å½“æœˆæ‰€æœ‰ `daily_records`
   - æå–æ‰€æœ‰ `summary` å­—æ®µ
   - ä¼ é€’ç»™ AI ç”Ÿæˆæœˆåº¦æ€»ç»“

2. **AI æ€»ç»“ç”Ÿæˆ**
   - è¿›å…¥é¡µé¢æ—¶è‡ªåŠ¨è§¦å‘ï¼ˆæˆ–ç‚¹å‡»"ç”Ÿæˆæ€»ç»“"æŒ‰é’®ï¼‰
   - ä½¿ç”¨å½“æœˆæ‰€æœ‰æ‘˜è¦ä½œä¸ºè¾“å…¥
   - è¿”å›ç»“æ„åŒ–çš„æœˆåº¦æŠ¥å‘Š

3. **å¯è§†åŒ–å±•ç¤º**
   - è¯äº‘å›¾ï¼šåŸºäº `content` å­—æ®µæå–å…³é”®è¯
   - é¢‘ç‡ç»Ÿè®¡ï¼šç»Ÿè®¡å­¦ä¹ ä¸»é¢˜å‡ºç°æ¬¡æ•°
   - æƒ…ç»ªè¶‹åŠ¿ï¼ˆå¯é€‰ï¼‰ï¼šåŸºäºå†…å®¹åˆ†ææƒ…ç»ªå˜åŒ–

---

## API æ¥å£è®¾è®¡

### Server Actionsï¼ˆæ¨èæ–¹å¼ï¼‰

#### 1. ä¿å­˜æ¯æ—¥è®°å½•

```typescript
// src/app/record/actions.ts
'use server'

import { createClient } from '@/lib/supabase/server';
import { generateDailySummary } from '@/lib/ai/zhipu';

export async function saveRecord(date: string, content: string) {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) throw new Error('æœªç™»å½•');

  // ä¿å­˜åŸå§‹å†…å®¹
  const { data: record, error } = await supabase
    .from('daily_records')
    .upsert({
      user_id: user.id,
      date,
      content,
      updated_at: new Date().toISOString()
    }, {
      onConflict: 'user_id,date'
    })
    .select()
    .single();

  if (error) throw error;

  // ç”Ÿæˆæ‘˜è¦
  const summary = await generateDailySummary(content);

  // æ›´æ–°æ‘˜è¦
  await supabase
    .from('daily_records')
    .update({ summary })
    .eq('id', record.id);

  return { success: true, summary };
}
```

#### 2. è·å–æ¯æ—¥è®°å½•

```typescript
export async function getRecord(date: string) {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) throw new Error('æœªç™»å½•');

  const { data, error } = await supabase
    .from('daily_records')
    .select('*')
    .eq('user_id', user.id)
    .eq('date', date)
    .single();

  if (error && error.code !== 'PGRST116') throw error;
  return data;
}
```

#### 3. è·å–æœˆåº¦è®°å½•åˆ—è¡¨

```typescript
export async function getMonthlyRecords(year: number, month: number) {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) throw new Error('æœªç™»å½•');

  const startDate = `${year}-${String(month).padStart(2, '0')}-01`;
  const endDate = `${year}-${String(month).padStart(2, '0')}-31`;

  const { data, error } = await supabase
    .from('daily_records')
    .select('date, summary, content')
    .eq('user_id', user.id)
    .gte('date', startDate)
    .lte('date', endDate)
    .order('date', { ascending: true });

  if (error) throw error;
  return data;
}
```

#### 4. ç”Ÿæˆæœˆåº¦æ€»ç»“

```typescript
export async function generateMonthlyReview(year: number, month: number) {
  const records = await getMonthlyRecords(year, month);
  const summaries = records.map(r => r.summary).filter(Boolean);
  
  if (summaries.length === 0) {
    return { error: 'æœ¬æœˆæš‚æ— è®°å½•' };
  }

  const review = await generateMonthlySummary(summaries);
  return review;
}
```

---

## AI é›†æˆ

### ZHIPU AI å®¢æˆ·ç«¯å°è£…

```typescript
// src/lib/ai/zhipu.ts
import { ZhipuAI } from '@zhipuai/sdk';

const client = new ZhipuAI({
  apiKey: process.env.ZHIPU_API_KEY!,
});

export async function generateDailySummary(content: string): Promise<string> {
  const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥è®°æ€»ç»“å’Œå­¦ä¹ æ•´ç†åŠ©æ‰‹ã€‚
è¯·å¯¹ä¸‹é¢çš„æ—¥è®°å†…å®¹ç”Ÿæˆä¸€ä¸ªä¸€å¥è¯çš„ç®€çŸ­æ€»ç»“ï¼Œç”¨äºæ˜¾ç¤ºåœ¨æ—¥å†æ ¼å­é‡Œã€‚
ä¿ç•™æ ¸å¿ƒå­¦ä¹ ç‚¹ã€é‡è¦äº‹ä»¶æˆ–åæ€ã€‚

æ—¥è®°å†…å®¹ï¼š
${content}

è¾“å‡ºæ ¼å¼ï¼šä¸€æ®µçŸ­æ–‡æœ¬ï¼ˆ50å­—ä»¥å†…ï¼‰ã€‚`;

  const response = await client.chat.completions.create({
    model: 'glm-4-flash',
    messages: [
      { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥è®°æ€»ç»“åŠ©æ‰‹ã€‚' },
      { role: 'user', content: prompt }
    ],
    temperature: 0.7,
    max_tokens: 100,
  });

  return response.choices[0].message.content || '';
}

export async function generateMonthlySummary(summaries: string[]): Promise<{
  overview: string;
  takeaways: string[];
  themes: Array<{ name: string; description: string }>;
}> {
  const prompt = `ä½ æ˜¯å­¦ä¹ ä¸æˆé•¿å¤ç›˜ä¸“å®¶ã€‚ç°åœ¨ä½ æ‹¿åˆ°æŸç”¨æˆ·åœ¨æœ¬æœˆçš„æ‰€æœ‰æ—¥è®°æ€»ç»“ã€‚

è¯·ç”Ÿæˆã€Šæœ¬æœˆå­¦ä¹ ä¸æˆé•¿æ€»ç»“ã€‹ï¼ŒåŒ…æ‹¬ï¼š
1. æœ¬æœˆæ•´ä½“è¡¨ç°æ¦‚è¿°ï¼ˆ150å­—å†…ï¼‰
2. æœ¬æœˆæœ€é‡è¦çš„5ä¸ªå­¦ä¹ æ”¶è·
3. æœ¬æœˆæœ€å¸¸å‡ºç°çš„ä¸»é¢˜ï¼ˆç»™å‡º3~5ä¸ªä¸»é¢˜å¹¶é™„ç®€è¿°ï¼‰

ä¸‹é¢æ˜¯è¿™ä¸ªæœˆçš„æ‰€æœ‰æ¯æ—¥æ€»ç»“ï¼š
${summaries.join('\n\n')}

è¯·ä»¥ JSON æ ¼å¼è¾“å‡ºï¼š
{
  "overview": "æ•´ä½“æ¦‚è¿°",
  "takeaways": ["æ”¶è·1", "æ”¶è·2", ...],
  "themes": [
    {"name": "ä¸»é¢˜å", "description": "æè¿°"},
    ...
  ]
}`;

  const response = await client.chat.completions.create({
    model: 'glm-4-flash',
    messages: [
      { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¤ç›˜ä¸“å®¶ï¼Œè¯·ä»¥ JSON æ ¼å¼è¾“å‡ºç»“æœã€‚' },
      { role: 'user', content: prompt }
    ],
    temperature: 0.7,
    response_format: { type: 'json_object' },
  });

  const result = JSON.parse(response.choices[0].message.content || '{}');
  return result;
}
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.local
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# ZHIPU AI
ZHIPU_API_KEY=your-zhipu-api-key
```

---

## å‰ç«¯å®ç°

### ç±»å‹å®šä¹‰

```typescript
// src/types/record.ts
export interface DailyRecord {
  id: string;
  user_id: string;
  date: string; // YYYY-MM-DD
  content: string;
  summary: string | null;
  created_at: string;
  updated_at: string;
}

// src/types/summary.ts
export interface MonthlySummary {
  overview: string;
  takeaways: string[];
  themes: Array<{
    name: string;
    description: string;
  }>;
}
```

### æ—¥å†ç»„ä»¶ç¤ºä¾‹

```typescript
// src/app/record/components/Calendar.tsx
'use client'

import { useState, useEffect } from 'react';
import { getRecord } from '../actions';

export function Calendar({ year, month }: { year: number; month: number }) {
  const [records, setRecords] = useState<Record<string, DailyRecord>>({});
  const [selectedDate, setSelectedDate] = useState<string | null>(null);

  // è·å–å½“æœˆæ‰€æœ‰è®°å½•
  useEffect(() => {
    // å®ç°è·å–é€»è¾‘
  }, [year, month]);

  // æ¸²æŸ“æ—¥å†æ ¼å­
  return (
    <div className="grid grid-cols-7 gap-2">
      {/* æ—¥å†æ ¼å­ */}
    </div>
  );
}
```

### ç¼–è¾‘å™¨ç»„ä»¶ç¤ºä¾‹

```typescript
// src/app/record/components/Editor.tsx
'use client'

import { useState, useEffect } from 'react';
import { saveRecord } from '../actions';

export function Editor({ date }: { date: string }) {
  const [content, setContent] = useState('');
  const [saving, setSaving] = useState(false);

  // ä» localStorage æ¢å¤è‰ç¨¿
  useEffect(() => {
    const draft = localStorage.getItem(`draft-${date}`);
    if (draft) setContent(draft);
  }, [date]);

  // è‡ªåŠ¨ä¿å­˜è‰ç¨¿
  useEffect(() => {
    const timer = setTimeout(() => {
      localStorage.setItem(`draft-${date}`, content);
    }, 1000);
    return () => clearTimeout(timer);
  }, [content, date]);

  const handleSave = async () => {
    setSaving(true);
    try {
      await saveRecord(date, content);
      localStorage.removeItem(`draft-${date}`);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div>
      <textarea
        value={content}
        onChange={(e) => setContent(e.target.value)}
        className="w-full h-64 p-4 border rounded"
        placeholder="è®°å½•ä»Šå¤©çš„å­¦ä¹ å’Œæƒ³æ³•..."
      />
      <button onClick={handleSave} disabled={saving}>
        {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
      </button>
    </div>
  );
}
```

---

## ç¯å¢ƒé…ç½®

### ä¾èµ–å®‰è£…

```bash
npm install @supabase/supabase-js @zhipuai/sdk
npm install -D @types/node
```

### package.json è„šæœ¬

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  }
}
```

### Supabase åˆå§‹åŒ–

1. åœ¨ Supabase æ§åˆ¶å°åˆ›å»ºé¡¹ç›®
2. æ‰§è¡Œ SQL åˆ›å»ºè¡¨ç»“æ„ï¼ˆè§[æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)ï¼‰
3. é…ç½® RLS ç­–ç•¥
4. è·å– API Keys å¹¶é…ç½®åˆ° `.env.local`

### å¼€å‘æµç¨‹

1. **å…‹éš†é¡¹ç›®** â†’ å®‰è£…ä¾èµ–
2. **é…ç½®ç¯å¢ƒå˜é‡** â†’ å¡«å†™ Supabase å’Œ AI å¯†é’¥
3. **åˆå§‹åŒ–æ•°æ®åº“** â†’ è¿è¡Œ SQL è„šæœ¬åˆ›å»ºè¡¨
4. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨** â†’ `npm run dev`
5. **å®ç°åŠŸèƒ½** â†’ æŒ‰ç…§æœ¬æ–‡æ¡£é€æ­¥å®ç°

---

## æ³¨æ„äº‹é¡¹

### æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨ Server Actions å‡å°‘å®¢æˆ·ç«¯ä»£ç 
- âœ… æ—¥å†æ•°æ®æŒ‰éœ€åŠ è½½ï¼ˆåªåŠ è½½å½“æœˆï¼‰
- âœ… AI è°ƒç”¨æ·»åŠ ç¼“å­˜ï¼ˆé¿å…é‡å¤ç”Ÿæˆï¼‰
- âœ… ä½¿ç”¨ React Suspense ä¼˜åŒ–åŠ è½½ä½“éªŒ

### é”™è¯¯å¤„ç†

- âœ… AI è°ƒç”¨å¤±è´¥æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
- âœ… ç½‘ç»œé”™è¯¯æ—¶è‡ªåŠ¨é‡è¯•
- âœ… ä¿å­˜å¤±è´¥æ—¶ä¿ç•™è‰ç¨¿åˆ° localStorage

### å®‰å…¨è€ƒè™‘

- âœ… ä½¿ç”¨ Supabase RLS ç¡®ä¿æ•°æ®éš”ç¦»
- âœ… API Key å­˜å‚¨åœ¨æœåŠ¡ç«¯ç¯å¢ƒå˜é‡
- âœ… ç”¨æˆ·è®¤è¯ä½¿ç”¨ Supabase Auth

---

## æ‰©å±•åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

- [ ] æ”¯æŒå¤šç”¨æˆ·ï¼ˆå·²å®ŒæˆåŸºç¡€æ¶æ„ï¼‰
- [ ] å¯¼å‡ºåŠŸèƒ½ï¼ˆPDF/Markdownï¼‰
- [ ] æœç´¢åŠŸèƒ½ï¼ˆå…¨æ–‡æœç´¢ï¼‰
- [ ] æ ‡ç­¾ç³»ç»Ÿ
- [ ] æƒ…ç»ªåˆ†æå¯è§†åŒ–
- [ ] ç§»åŠ¨ç«¯é€‚é…ï¼ˆPWAï¼‰

---

**æœ€åæ›´æ–°ï¼š** 2025-01-XX
